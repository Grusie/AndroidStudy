# 17 - 1 데이터베이스에 보관하기

## SQLite

> 안드로이드 폰에서 이용하는 데이터베이스 관리 시스템
>
> 데이터를 앱의 저장소에 파일로 저장 -> 외부 앱에서 접근할 수 없다

Query(질의문) : 데이터베이스에 정보를 요청하는 것

### Query 작성

> SQLite를 사용하기 위해 SqLiteDataBase라는 API 이용

> * SQLiteDatabase 객체 생성 -> execSQL, rawQuery 실행 가능
>
> execSQL : create, alter ,drop, insert, update, delete 문을 실행하는 함수
>
> rawQuery : select 문 실행 > return값 Cursor 객체
>
> 첫 번째 매개변수 = query 전달 , 두 번째 매개변수 = ? 문자에 대응하는 값을 배열로 전달

> * 조회 방법 : Cursor 객체로 행 선택 > 행의 열 데이터 가져오기
>
> 행 선택 : moveTo~ 함수 이용 > return값 Boolean ( true: 선택한 행이 있을 경우, false: 선택한 행이 없을 경우)
~~~
public abstract boolean moveToFirst(): 첫 번째 행 선택
public abstract boolean moveToLast(): 마지막 행 선택
public abstract boolean moveToNext(): 다음 행 선택
public abstract boolean moveToPosition(int position): 지정한 위치 행 선택
public abstract boolean moteToPrevious(): 이전 행 선택
~~~

> 열 데이터 가져오기 > 타입에 따라 사용
~~~
public abstract String getString(int columnIndex)
public abstract Int getInt(int columnIndex)
~~~
~~~
val db = openOrCreateDatabase("testdb", Context.MODE_PRIVATE, null) // DB 파일 이름: textdb

//테이블 생성 create문
db.execSQL("create table USER_TB (" +
    "id integer primary key autoincrement," +
    "name not null," +
    "phone)")

//데이터 삽입 insert문
db.execSQL("insert into USER_TB (name, phone) values (?,?)", arrayOf("dong","010111"))

//데이터 조회 select문
val cursor = db.rawQuery("select * from USER_TB", null)

while (cursor.moveToNext()){while(cursor.moveToNext()){
    val name = cursor.getString(0)
    val phone = cursor.getString(1)
}
~~~

-> insert(), update(), delete(), query() 함수도 사용 가능
~~~
//insert() 함수 사용
val values = ContentValues() // 열 데이터의 집합 -> 키-값 형태로 데이터 집합 저장
values.put("name", "dong2")
values.put("phone", "0102222")
db.insert("USER_TB", null, values)

//query() 함수 사용
val cursor2 = db.query("USER_TB", arrayOf("name", "phone"), "phone=?",
    arrayOf("0103333"), null, null, null)
~~~

## SQLiteOpenHelper

> SQLite 데이터베이스는 반드시 SQliteDatabase 객체 이용해야 함 + SQLiteOpenHelper 이용하면 더 구조적으로 작성 가능
>
> SQLiteOpenHelper > 데이터베이스를 관리(생성, 변경, 제거)하는 코드를 추상화
~~~
class DBHelper(context: Context): SQLiteOpenHelper(context, "testdb", null, 1){
    override fun onCreate(db: SQLiteDatabase?) {}
    override fun onUpgrade(db: SQLiteDatabase?, oldVersion: Int, newVersion: Int) {}
}
~~~
-> 두번째: db 파일명, 네번째: 개발자가 지정하는 DB 버전 정보

-> onCreate(): 앱이 설치된 후 최초에 한 번만 호출 -> DB 테이블 생성하는 코드 주로 작성

-> onUpgrade(): DB 버전 정보가 변경될 때마다 호출 -> 테이블의 스키마(데이터의 구조, 표현 방법, 관계 등)를 변경하는 코드 주로 작성

참고 자료
~~~
data class Times(var no:Long?, var day:String, var startTime:Long?, var endTime:Long?, var durTime:Long?)

class SqliteHelper(context: Context, name: String, version: Int): SQLiteOpenHelper (context, name, null, version){

    override fun onCreate(db: SQLiteDatabase?) {
        val create = "create table times" +
                "(" +
                "no integer primary key," +
                "day text," +
                "startTime integer," +
                "endTime integer," +
                "durTime integer" +
                ")"
        db?.execSQL(create)
    }

    override fun onUpgrade(db: SQLiteDatabase?, oldVersion: Int, newVersion: Int) {
    }

    //삽입 메서드
    fun insertTime(times: Times){
        val values = ContentValues()
        values.put("no", times.no)
        values.put("day", times.day)
        values.put("startTime", times.startTime)
        values.put("endTime", times.endTime)
        values.put("durTime", times.durTime)

        val wd = writableDatabase
        wd.insert("times", null, values)
        wd.close()
    }

    //조회 메서드
    fun selectTime():MutableList<Times>{
        val list = mutableListOf<Times>()
        val select = "select * from times"
        val rd = readableDatabase
        val cursor = rd.rawQuery(select, null)
        while(cursor.moveToNext()){
            val no = cursor.getLong(cursor.getColumnIndex("no"))
            val day = cursor.getString(cursor.getColumnIndex("day"))
            val startTime = cursor.getLong(cursor.getColumnIndex("startTime"))
            val endTime = cursor.getLong(cursor.getColumnIndex("endTime"))
            val durTime = cursor.getLong(cursor.getColumnIndex("durTime"))

            list.add(Times(no, day, startTime, endTime, durTime))
        }

        cursor.close()
        rd.close()
        return list
    }

    //수정 메서드
    fun updateTime(times: Times){
        val values = ContentValues()
        values.put("no", times.no)
        values.put("day", times.day)
        values.put("startTime", times.startTime)
        values.put("endTime", times.endTime)
        values.put("durTime", times.durTime)

        val wd = writableDatabase
        wd.update("times", values, "no = ${times.no}", null)
        wd.close()
    }

    //삭제 메서드
    fun deleteTime(times: Times){
        val delete = "delete from times where no = ${times.no}"
        val wd = writableDatabase
        wd.execSQL(delete)
        wd.close()
    }
}
~~~

# 17 - 2 파일에 보관하기