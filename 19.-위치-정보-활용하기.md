# 19 - 1 사용자 위치 얻기

## 위치 접근 권한

* 메니페스트 파일에 권한 등록 : 앱에서 사용자의 위치 추적

> android.permission.ACCESS_COARSE_LOCATION : 와이파이나 모바일 데이터로 위치 접근, 도시에서 1블록 정도의 오차 수준
>
> -> 대략 어느 블록 안에 있는지만 파악
>
> android.permission.ACCESS_FINE_LOCATION : 위성, 와이파이, 데이터 등 이용할 수 있는 위치제공자를 사용해 최대한 정확한 위치 접근
>
> -> 길 안내와 같이 높은 정확도로 파악
>
> android.permission.ACCESS_BACKGROUND_LOCATION : API 레벨 29 이상에서 백그라운드 상태에서 위치 접근
>
> -> 안드로이드 10 이상 > 앱이 백그라운드 상태일 때 위치 파악 ( 10 미만은 포그라운드 위치 권한 얻을 시 백그라운드 위치 권한 자동 부여)
>
> android: foregroundServiceType = "location" : 서비스 컴포넌트에서 위치 접근 -> 메니페스트 서비스 등록 시 속성으로 설정

## 플랫폼 API의 위치 매니저

* LocationManager라는 시스템 서비스 이용
~~~
val manager = getSystemService(LOCATION_SERVICE) as LocationManager
~~~

* 위치 제공자 지정 : GPS, Network, Wifi, Passive(다른 앱에서 이용한 마지막 위치 정보 이용)

기기에서 제공하는 위치 제공자 확인
~~~
val providers = manager.allProviders
Log.d("test", providers.toString()) // [passive, network, gps]
~~~

지금 사용할 수 있는 위치 제공자 확인
~~~
val enabledProviders = manager.getProviders(true)
Log.d("test", enabledProviders.toString()) // [passive, network, gps]
~~~

* 위치 정보 얻기

LocationManager의 getLastKnownLocation() 함수 이용 : 위치를 한 번만 가져올 때 사용
~~~
if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.ACCESS_FINE_LOCATION)
== PackageManager.PERMISSION_GRANTED){ // permission을 받으면 실행
    
    val location: Location? = manager.getLastKnownLocation(LocationManager.GPS_PROVIDER)
    location?.let {
        val latitude = it.latitude // 위도
        val longitude = it.longitude // 경도
        val accuracy = it.accuracy // 정확도
        val time = it.time // 시간

        Log.d("test", "$latitude, $longitude, $accuracy, $time") // 37.421998333333335, -122.084, 5.0, 1636690387255
    }
} else{
    //permission을 받지 못했을 시 permission 요청 팝업
    ActivityCompat.requestPermissions(this, arrayOf(android.Manifest.permission.ACCESS_FINE_LOCATION), 10)
}
~~~

LocationManager의 requestLocationUpdates 함수에 LocationListener 등록 : 계속 위치를 가져와야 할 때 사용
~~~
val listener : LocationListener = object : LocationListener{ // LocationListener 생성
    override fun onLocationChanged(location: Location) { //override 필수
        val provider = location.provider
        val latitude = location.latitude
        val longitude = location.longitude
        val altitude = location.altitude

        Log.d("test_onLocationChanged", "$provider, $latitude, $longitude, $altitude")
    }

    override fun onProviderEnabled(provider: String) { //override 선택
        super.onProviderEnabled(provider)
    }
    override fun onProviderDisabled(provider: String) { //override 선택
        super.onProviderDisabled(provider)
    }
}

manager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 5000L, 10f, listener)
//매개변수 -> provider / 위치 전달 주기 ms / 지정 거리 변경 시 위치 전달 / LocationListener 
manager.removeUpdates(listener) // 사용이 끝나면 해제
~~~

조건(Criteria)에 맞는 위치 제공자 지정 : 설정한 제공자 조건에 맞는 제공자 선택
~~~
val criteria = Criteria()
criteria.isAltitudeRequired = false // 외에 정확도, 고도, 방향, 비용 드는 것 허용, 속도, 전원 소모량 등 설정 가능

val provider = manager.getBestProvider(criteria, true)
~~~

## Google Play Service의 위치 라이브러리

> 위의 방법을 통해 위치 제공자 결정에는 많은 것을 신경써야 함 -> 최적의 알고리즘으로 위치 제공자 지정 : Fused Location Provider

라이브러리 선언
~~~
implementation 'com.google.android.gms:play-services:12.0.1'
~~~

> * 핵심 클래스
>
> FusedLocationProviderClient : 위치 정보 얻기
>
> GoogleApiClient : 위치 제공자 준비 등 다양한 콜백 제공
>
> GoogleApiClient에서 위치 정보 제공자 결정 > FusedLocationProviderClient에서 위치 가져오기

~~~
// FusedLocationProviderClient 초기화
val providerClient = LocationServices.getFusedLocationProviderClient(this)

//GoogleApiClient 초기화 ( GoogleApiClient에 추가할 connectionCallback, onConnectionFailedCallback 선언)
val connectionCallback = object : GoogleApiClient.ConnectionCallbacks{
    override fun onConnected(p0: Bundle?) {
        // 위치 제공자를 사용할 수 있을 때

        if(ContextCompat.checkSelfPermission(this@MainActivity, android.Manifest.permission.ACCESS_FINE_LOCATION)
            == PackageManager.PERMISSION_GRANTED){
            providerClient.lastLocation.addOnSuccessListener(this@MainActivity) { p0 ->
            // FusedLocationProviderClient의 lastLocation 호출 -> 마지막으로 알려진 사용자 기기의 위치 요청
                val latitude = p0?.latitude
                val longitude = p0?.longitude
            }
        }
    }

    override fun onConnectionSuspended(p0: Int) {
        // 위치 제공자를 사용할 수 없을 때
    }
}

val onConnectionFailedCallback = object : GoogleApiClient.OnConnectionFailedListener{
    override fun onConnectionFailed(p0: ConnectionResult) {
        // 사용할 수 있는 위치 제공자가 없을 때
    }
}

val apiClient = GoogleApiClient.Builder(this)
    .addApi(LocationServices.API)
    .addConnectionCallbacks(connectionCallback)
    .addOnConnectionFailedListener(onConnectionFailedCallback)
    .build()

apiClient.connect()
~~~
